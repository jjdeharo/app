<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor LaTeX online</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: {'[+]': ['cases', 'mathtools']}
            },
            svg: {
                fontCache: 'local'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    initializeLatexEditor();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --danger-dark: #a71d2a;
            --success-color: #28a745;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --white: #ffffff;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: var(--white); }
        .header h1 { font-size: 2.5rem; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; margin: 0; }
        .tabs-section { position: relative; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 20px; overflow: hidden; }
        
        .search-wrapper { 
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px 10px 20px; 
            border-bottom: 1px solid var(--medium-gray); 
        }
        #search-input { 
            flex-grow: 1;
            padding: 12px; 
            border-radius: 8px; 
            border: 2px solid var(--medium-gray); 
            font-size: 1rem; 
            transition: all 0.3s ease; 
        }
        #search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        #settings-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            transition: transform 0.3s, color 0.3s;
            padding: 0 5px;
            flex-shrink: 0;
        }
        #settings-btn:hover {
            color: var(--primary-color);
            transform: rotate(45deg);
        }
        .search-results-view .tabs-container { display: none; }
        .search-results-view .tab-content { display: grid !important; }
        .tabs-container { display: flex; flex-wrap: wrap; background: var(--light-gray); border-bottom: 3px solid var(--medium-gray); }
        .tab-btn { padding: 15px 20px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: var(--dark-gray); transition: all 0.3s ease; position: relative; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: var(--medium-gray); color: var(--text-color); }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .toolbar-wrapper { padding: 20px; background: var(--white); }
        .tab-content { display: none; gap: 10px; }
        .tab-content.active { display: grid; }
        .toolbar-btn { background: var(--white); border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px 10px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toolbar-btn:hover { border-color: var(--primary-color); background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.2); }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: var(--white); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); display: flex; flex-direction: column; }
        .panel h2 { margin: 0 0 15px 0; color: #333; font-size: 1.3rem; border-bottom: 2px solid var(--medium-gray); padding-bottom: 10px; }
        #latex-input { width: 100%; height: 200px; border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; transition: all 0.3s ease; flex-grow: 1; }
        #latex-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .preview-container { min-height: 200px; border: 2px dashed var(--medium-gray); border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center; background: var(--light-gray); flex-grow: 1; }
        #preview { font-size: 24px; color: var(--text-color); overflow-x: auto; overflow-y: hidden; width: 100%; text-align: center; }
        .copy-options-container { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .copy-options-container label { font-size: 0.9rem; color: var(--dark-gray); font-weight: 500; }
        #delimiter-selector { font-family: inherit; padding: 5px 8px; border-radius: 8px; border: 2px solid var(--medium-gray); background-color: white; transition: border-color 0.2s ease-in-out; }
        #delimiter-selector:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .panel-actions { margin-top: 15px; text-align: center; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--primary-dark)); color: white; }
        .btn-secondary { background: linear-gradient(45deg, var(--secondary-color), #495057); color: white; }
        .btn-danger { background: linear-gradient(45deg, var(--danger-color), var(--danger-dark)); color: white; }
        .btn-success { background: linear-gradient(45deg, var(--success-color), #1e7e34); color: white; }
        .btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .copy-feedback { color: var(--primary-color); font-weight: 600; margin-top: 10px; height: 20px; opacity: 0; transition: opacity 0.5s ease; text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white); padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: inline-block; max-width: 90vw; max-height: 90vh; text-align: left; transform: scale(0.9); transition: transform 0.3s; overflow: auto; width: 500px; max-width: 90%;}
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2 { text-align: center; margin-top: 0; }
        #modal-message { margin: 0 0 20px 0; font-size: 1.1rem; line-height: 1.5; text-align: center; }
        #modal-message img { display: block; margin: 0 auto; }
        #alert-modal-message p { margin: 0 0 10px 0; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-content .form-group { margin-bottom: 20px; }
        .modal-content .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .modal-content .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--medium-gray); font-size: 1rem; }
        .modal-content .link-group { text-align: center; margin: -10px 0 15px 0; font-size: 0.95em; }
        .modal-content .link-group a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        .modal-content .link-group a:hover { text-decoration: underline; }
        #modal-feedback { font-size: 0.9em; height: 20px; text-align: center; }
        .footer { text-align: center; padding: 30px 20px; color: white; opacity: 0.9; font-size: 0.9rem; }
        .footer a { color: #ffffff; font-weight: 600; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        
        /* Estilos para el constructor de matrices */
        .matrix-builder {
            border: 2px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 10px;
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 10px 15px;
            background-color: var(--light-gray);
        }
        .matrix-builder-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .matrix-builder-group label {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--dark-gray);
            white-space: nowrap;
        }
        .matrix-builder-group input, .matrix-builder-group select {
            padding: 6px;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
            font-size: 0.9rem;
            width: 65px;
        }
        .matrix-builder-group select {
            width: auto;
            min-width: 140px;
        }
        .matrix-builder-delimiters {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .matrix-builder-delimiters .btn {
            padding: 6px 14px;
            font-size: 1.1rem;
        }

        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; }
            .tab-btn { padding: 12px 15px; font-size: 14px; }
            .container { padding: 10px; }
            .modal-content { padding: 20px; }
            .matrix-builder {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Editor LaTeX online</h1>
            <p>Crea fórmulas matemáticas visualmente, cópialas o descárgalas como imagen.</p>
        </header>

        <div id="tabs-section" class="tabs-section">
            <div class="search-wrapper">
                <input type="search" id="search-input" placeholder="Buscar por descripción o código (ej: fracción, \int)..." autocomplete="off">
                <button id="settings-btn" title="Personalizar menú">⚙️</button>
            </div>
            <div id="tabs-container" class="tabs-container"></div>
            <div class="toolbar-wrapper">
                <div id="toolbar"></div>
            </div>
        </div>

        <div class="main-content">
             <div class="panel">
                <h2>Código LaTeX</h2>
                <textarea id="latex-input" placeholder="Escribe aquí tu código... \frac{a}{b}" spellcheck="false"></textarea>
                <div class="copy-options-container">
                    <label for="delimiter-selector">Copiar con delimitadores:</label>
                    <select id="delimiter-selector" class="mathjax_ignore">
                        <option value="none" selected>Sin delimitadores</option>
                        <option value="parentheses">\(...\)</option>
                        <option value="brackets">\[...\]</option>
                        <option value="double_dollar">$$...$$</option>
                        <option value="single_dollar">$...$</option>
                    </select>
                </div>
                <div class="panel-actions">
                      <button id="copy-button" class="btn btn-primary">Copiar código LaTeX</button>
                      <button id="clear-button" class="btn btn-secondary">Borrar código</button>
                </div>
                <div id="copy-code-feedback" class="copy-feedback"></div>
            </div>
            <div class="panel">
                <h2>Previsualización</h2>
                <div class="preview-container">
                    <div id="preview"></div>
                </div>
                <div class="panel-actions">
                    <button id="view-image-button" class="btn btn-success">Visualizar imagen</button>
                </div>
                 <div id="copy-image-feedback" class="copy-feedback"></div>
            </div>
        </div>
    </div>
    
    <footer id="page-footer" class="footer"></footer>

    <div id="image-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Personalizar Menú</h2>
            <div class="form-group">
                <label for="url-input">Cargar menú desde URL</label>
                <input type="url" id="url-input" placeholder="https://ejemplo.com/formulas.json">
            </div>
            <div class="form-group">
                <label for="file-input">Cargar menú desde archivo local</label>
                <input type="file" id="file-input" accept=".json,application/json">
            </div>
            <div class="link-group">
                <a href="./editor_menu.html" target="_blank" rel="noopener noreferrer">Con este programa podrás personalizar tu propio menú.</a>
            </div>
            <div id="modal-feedback"></div>
            <div class="modal-buttons">
                <button id="restore-default-btn" class="btn btn-secondary">Restaurar por defecto</button>
                <button id="close-settings-btn" class="btn btn-danger">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="alert-modal-title" style="text-align: center;"></h2>
            <div id="alert-modal-message" style="font-size: 1rem; line-height: 1.5;"></div>
            <div class="modal-buttons">
                <button id="alert-modal-close-btn" class="btn btn-primary">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        async function initializeLatexEditor() {
            // Referencias a elementos del DOM
            const latexInput = document.getElementById('latex-input');
            const preview = document.getElementById('preview');
            const copyButton = document.getElementById('copy-button');
            const clearButton = document.getElementById('clear-button');
            const viewImageButton = document.getElementById('view-image-button');
            const delimiterSelector = document.getElementById('delimiter-selector');
            const copyCodeFeedback = document.getElementById('copy-code-feedback');
            const tabsContainer = document.getElementById('tabs-container');
            const toolbar = document.getElementById('toolbar');
            const searchInput = document.getElementById('search-input');
            const imageModal = document.getElementById('image-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const urlInput = document.getElementById('url-input');
            const fileInput = document.getElementById('file-input');
            const restoreDefaultBtn = document.getElementById('restore-default-btn');
            const modalFeedback = document.getElementById('modal-feedback');
            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');

            // --- CONFIGURACIÓN ---
            const DEFAULT_MENU_URL = 'https://raw.githubusercontent.com/jjdeharo/app/refs/heads/main/mat/editor_latex/formulas.json';
            const LOCAL_MENU_URL = './formulas.json';
            const MAX_RECENTS = 12;

            // --- ESTADO DE LA APLICACIÓN ---
            let toolbarData = null;
            let recentSymbols = [];
            
            // --- GESTIÓN DE LOCALSTORAGE Y DATOS RECIENTES ---
            function loadRecents() {
                recentSymbols = JSON.parse(localStorage.getItem('latexRecents')) || [];
            }
            function saveRecents() {
                localStorage.setItem('latexRecents', JSON.stringify(recentSymbols));
            }
            function createRecentsTab() {
                if (document.querySelector('[data-tab="recientes"]')) return;
                const recentsTabButton = document.createElement('button');
                recentsTabButton.className = 'tab-btn';
                recentsTabButton.dataset.tab = 'recientes';
                recentsTabButton.textContent = 'Recientes';
                tabsContainer.prepend(recentsTabButton);
                const recentsContentDiv = document.createElement('div');
                recentsContentDiv.id = 'tab-recientes';
                recentsContentDiv.className = 'tab-content';
                toolbar.prepend(recentsContentDiv);
            }
            function trackSymbolUsage(latexCode) {
                if (recentSymbols.length === 0) createRecentsTab();
                recentSymbols = recentSymbols.filter(item => item !== latexCode);
                recentSymbols.unshift(latexCode);
                if (recentSymbols.length > MAX_RECENTS) recentSymbols = recentSymbols.slice(0, MAX_RECENTS);
                saveRecents();
                const recentsContent = document.getElementById('tab-recientes');
                if (recentsContent) {
                    recentsContent.innerHTML = '';
                    renderTabContent('recientes');
                }
            }
            
            // --- FUNCIONES DE MODALES ---
            function showAlert(title, htmlMessage) {
                alertModalTitle.textContent = title;
                alertModalMessage.innerHTML = htmlMessage;
                alertModal.classList.add('active');
            }
            function hideAlert() { alertModal.classList.remove('active'); }
            function showImageModal(message, buttons) {
                modalMessage.innerHTML = message;
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `btn ${btnInfo.class}`;
                    button.onclick = () => {
                        if(btnInfo.action) btnInfo.action();
                        hideImageModal();
                    };
                    modalButtons.appendChild(button);
                });
                imageModal.classList.add('active');
            }
            function hideImageModal() { imageModal.classList.remove('active'); }
            function openSettingsModal() { settingsModal.classList.add('active'); }
            function closeSettingsModal() { settingsModal.classList.remove('active'); }
            function showModalFeedback(message, isError = false) {
                modalFeedback.textContent = message;
                modalFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                setTimeout(() => modalFeedback.textContent = '', 3000);
            }

            // --- LÓGICA DE CARGA DE MENÚ ---
            async function initializeMenu() {
                const customUrl = localStorage.getItem('latexCustomMenuUrl');
                if (customUrl) {
                    await loadMenuFromUrl(customUrl);
                    return;
                }
                try {
                    const response = await fetch(LOCAL_MENU_URL);
                    if (!response.ok) throw new Error('Menú local no encontrado');
                    const data = await response.json();
                    rebuildToolbar(data);
                    console.log("Menú local (formulas.json) cargado con éxito.");
                } catch (error) {
                    console.warn("No se pudo cargar el menú local. Cargando menú por defecto.", error);
                    await loadMenuFromUrl(DEFAULT_MENU_URL, true);
                }
            }
            function rebuildToolbar(data) {
                if (!data || !Array.isArray(data.categorias)) {
                    showModalFeedback('El archivo JSON no tiene el formato correcto.', true);
                    return false;
                }
                toolbarData = data;
                allTabsRenderedForSearch = false;
                tabsContainer.innerHTML = '';
                toolbar.innerHTML = '';
                let isFirstTab = true;
                if (recentSymbols.length > 0) {
                    createRecentsTab();
                    tabsContainer.querySelector('[data-tab="recientes"]').classList.add('active');
                    toolbar.querySelector('#tab-recientes').classList.add('active');
                    isFirstTab = false;
                }
                toolbarData.categorias.forEach((categoria) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'tab-btn';
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `tab-${categoria.id}`;
                    contentDiv.className = 'tab-content';
                    if (isFirstTab) {
                       tabButton.classList.add('active');
                       contentDiv.classList.add('active');
                       isFirstTab = false;
                    }
                    tabButton.dataset.tab = categoria.id;
                    tabButton.textContent = categoria.nombre;
                    tabsContainer.appendChild(tabButton);
                    toolbar.appendChild(contentDiv);
                });
                const activeTab = tabsContainer.querySelector('.tab-btn.active');
                if(activeTab) renderTabContent(activeTab.dataset.tab);
                return true;
            }
            async function loadMenuFromUrl(url, showLocalFailNotification = false) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    const data = await response.json();
                    if (rebuildToolbar(data)) {
                        if (url !== DEFAULT_MENU_URL) {
                            localStorage.setItem('latexCustomMenuUrl', url);
                            showModalFeedback('Menú cargado desde URL correctamente.');
                        }
                        urlInput.value = localStorage.getItem('latexCustomMenuUrl') || '';
                        if (showLocalFailNotification) {
                             showAlert(
                                'Aviso de carga de menú',
                                `<p>No se pudo cargar el menú local <code>${LOCAL_MENU_URL}</code>.</p>
                                <p style="font-size: 0.9em;">Esto suele ocurrir al abrir el archivo HTML directamente desde el ordenador. Para usar un menú local, la aplicación debe ejecutarse en un servidor web.</p>
                                <p>Se ha cargado el menú por defecto. Puede usar el botón de configuración (⚙️) para cargar un menú personalizado desde una URL o un archivo.</p>`
                            );
                        }
                    }
                } catch (error) {
                    console.error("Error cargando menú desde URL:", error);
                    showModalFeedback('No se pudo cargar o procesar la URL.', true);
                }
            }
            function loadMenuFromFile(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (rebuildToolbar(data)) {
                            localStorage.removeItem('latexCustomMenuUrl');
                            showModalFeedback(`Menú cargado desde "${file.name}".`);
                            urlInput.value = '';
                        }
                    } catch (error) {
                         showModalFeedback('El archivo no es un JSON válido.', true);
                    }
                };
                reader.readAsText(file);
            }
            function restoreDefaultMenu() {
                localStorage.removeItem('latexCustomMenuUrl');
                urlInput.value = '';
                loadMenuFromUrl(DEFAULT_MENU_URL);
                showModalFeedback('Menú por defecto restaurado.');
            }
            
            // --- FUNCIONES DEL EDITOR ---
            function updatePreview() {
                preview.innerHTML = latexInput.value.trim() === "" ? "" : `$$${latexInput.value.trim()}$$`;
                MathJax.typesetPromise([preview]).catch(err => {
                    preview.innerHTML = `<span style="color:red;">Error de sintaxis</span>`;
                });
            }
            function insertAtCursor(textToInsert) {
                const startPos = latexInput.selectionStart;
                const endPos = latexInput.selectionEnd;
                latexInput.value = latexInput.value.substring(0, startPos) + textToInsert + latexInput.value.substring(endPos);
                let cursorPos = textToInsert.indexOf('{}');
                latexInput.selectionStart = latexInput.selectionEnd = startPos + (cursorPos !== -1 ? cursorPos + 1 : textToInsert.length);
                latexInput.focus();
                updatePreview();
                if (textToInsert.includes('\\begin{')) return;
                trackSymbolUsage(textToInsert);
            }
            function generateImage(callback) {
                const svgElement = preview.querySelector('svg');
                if (!svgElement) {
                    showImageModal('<p>No hay fórmula para capturar.</p>', [{text: 'OK', class: 'btn-primary'}]);
                    return;
                }
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgElement);
                const img = new Image();
                const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
                const url = URL.createObjectURL(svgBlob);
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const padding = 20;
                    canvas.width = svgElement.width.baseVal.value + padding * 2;
                    canvas.height = svgElement.height.baseVal.value + padding * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, padding, padding, svgElement.width.baseVal.value, svgElement.height.baseVal.value);
                    URL.revokeObjectURL(url);
                    callback(canvas);
                };
                img.src = url;
            }
            function handleViewImage() {
                generateImage(canvas => {
                    const imgElement = document.createElement('img');
                    imgElement.src = canvas.toDataURL('image/png');
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.maxHeight = '80vh';
                    const instruction = document.createElement('p');
                    instruction.textContent = 'Clic derecho sobre la imagen para guardarla o copiarla.';
                    const messageContainer = document.createElement('div');
                    messageContainer.appendChild(imgElement);
                    messageContainer.appendChild(instruction);
                    showImageModal(messageContainer.innerHTML, [{text: 'Cerrar', class: 'btn-secondary'}]);
                });
            }
            
            // --- LÓGICA CONSTRUCTOR DE MATRICES ---
            function createMatrixBuilderUI(elemento) {
                const container = document.createElement('div');
                container.className = 'matrix-builder';
                container.dataset.title = elemento.title || 'Matriz personalizada';
                container.innerHTML = `
                    <div class="matrix-builder-group">
                        <label for="mb-rows">Filas:</label>
                        <input type="number" id="mb-rows" value="2" min="1" max="20">
                    </div>
                    <div class="matrix-builder-group">
                        <label for="mb-cols">Columnas:</label>
                        <input type="number" id="mb-cols" value="2" min="1" max="20">
                    </div>
                    <div class="matrix-builder-group">
                        <label for="mb-fill">Rellenar:</label>
                        <select id="mb-fill">
                            <option value="subscripts">Subíndices (a, b...)</option>
                            <option value="zeros">Ceros (0)</option>
                            <option value="ones">Unos (1)</option>
                            <option value="vars">Variables (a, b, c...)</option>
                            <option value="numbers">Números (1, 2, 3...)</option>
                            <option value="empty">Vacío ({})</option>
                        </select>
                    </div>
                    <div class="matrix-builder-delimiters">
                        <button class="btn" data-delimiter="pmatrix">()</button>
                        <button class="btn" data-delimiter="bmatrix">[]</button>
                        <button class="btn" data-delimiter="vmatrix">||</button>
                        <button class="btn" data-delimiter="Vmatrix">|||</button>
                    </div>
                `;

                container.querySelector('.matrix-builder-delimiters').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    const rows = parseInt(container.querySelector('#mb-rows').value, 10);
                    const cols = parseInt(container.querySelector('#mb-cols').value, 10);
                    const fillType = container.querySelector('#mb-fill').value;
                    const delimiter = button.dataset.delimiter;

                    const matrixCode = generateMatrixCode(rows, cols, fillType, delimiter);
                    insertAtCursor(matrixCode);
                });

                return container;
            }
            function generateMatrixCode(rows, cols, fillType, delimiter) {
                if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) return '';
                let content = '';
                const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                let counter = 0;

                for (let i = 1; i <= rows; i++) {
                    for (let j = 1; j <= cols; j++) {
                        let cell;
                        switch(fillType) {
                            case 'subscripts': cell = `a_{${i}${j}}`; break;
                            case 'zeros': cell = '0'; break;
                            case 'ones': cell = '1'; break;
                            case 'vars': cell = alphabet[counter % alphabet.length]; counter++; break;
                            case 'numbers': cell = (counter + 1).toString(); counter++; break;
                            case 'empty': cell = '{}'; break;
                            default: cell = '';
                        }
                        content += cell + (j < cols ? ' & ' : '');
                    }
                    if (i < rows) content += ' \\\\\n  ';
                }
                return `\\begin{${delimiter}}\n  ${content}\n\\end{${delimiter}}`;
            }

            // --- LÓGICA DE PESTAÑAS Y BÚSQUEDA ---
            function normalizeString(str) {
                if (typeof str !== 'string') return '';
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            function renderTabContent(tabId) {
                const contentDiv = document.getElementById(`tab-${tabId}`);
                if (!contentDiv || contentDiv.childElementCount > 0) return;
                let elementsToRender = [];
                let gridColumns = "repeat(auto-fill, minmax(80px, 1fr))";
                if (tabId === 'recientes') {
                    gridColumns = `repeat(${Math.min(MAX_RECENTS, 6)}, 1fr)`;
                    recentSymbols.forEach(latexCode => {
                        for (const categoria of toolbarData.categorias) {
                            const found = categoria.elementos.find(el => el.latex === latexCode);
                            if (found) { elementsToRender.push(found); break; }
                        }
                    });
                     if (elementsToRender.length === 0) {
                        contentDiv.innerHTML = '<p style="color: var(--dark-gray); grid-column: 1 / -1; text-align:center;">Aún no hay símbolos recientes.</p>';
                        return;
                    }
                } else {
                    const categoria = toolbarData.categorias.find(c => c.id === tabId);
                    if (categoria) {
                        elementsToRender = categoria.elementos;
                        gridColumns = categoria.grid_template_columns || gridColumns;
                    }
                }
                contentDiv.style.gridTemplateColumns = gridColumns;
                elementsToRender.forEach(elemento => {
                    if (elemento.type === 'custom_matrix') {
                        const matrixBuilder = createMatrixBuilderUI(elemento);
                        contentDiv.appendChild(matrixBuilder);
                    } else {
                        const button = document.createElement('button');
                        button.className = 'toolbar-btn';
                        button.dataset.latex = elemento.latex;
                        button.title = elemento.title;
                        button.innerHTML = `\\(${elemento.display || elemento.latex}\\)`;
                        contentDiv.appendChild(button);
                    }
                });
                MathJax.typesetPromise(contentDiv.querySelectorAll('.toolbar-btn'));
            }
            function handleTabSwitch(event) {
                const button = event.target.closest('.tab-btn');
                if (!button) return;
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                toolbar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(`tab-${tabId}`).classList.add('active');
                renderTabContent(tabId);
            }
            let allTabsRenderedForSearch = false;
            searchInput.addEventListener('input', (e) => {
                const query = normalizeString(e.target.value.trim());
                tabsContainer.parentElement.classList.toggle('search-results-view', query.length > 0);
                if (query.length > 0) {
                    if (!allTabsRenderedForSearch) {
                        if (recentSymbols.length > 0) renderTabContent('recientes');
                        toolbarData.categorias.forEach(cat => renderTabContent(cat.id));
                        allTabsRenderedForSearch = true;
                    }
                    toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
                        const title = normalizeString(btn.title);
                        const latex = normalizeString(btn.dataset.latex);
                        const isVisible = title.includes(query) || latex.includes(query);
                        btn.style.display = isVisible ? 'flex' : 'none';
                    });
                     toolbar.querySelectorAll('.matrix-builder').forEach(builder => {
                        const title = normalizeString(builder.dataset.title);
                        builder.style.display = title.includes(query) ? 'flex' : 'none';
                    });
                } else {
                    toolbar.querySelectorAll('.toolbar-btn').forEach(btn => { btn.style.display = 'flex'; });
                    toolbar.querySelectorAll('.matrix-builder').forEach(builder => { builder.style.display = 'flex'; });
                }
            });

            // --- FOOTER ---
            function addFooter() {
                const footer = document.getElementById('page-footer');
                footer.innerHTML = `
                    <p style="margin-bottom: 10px;">
                        <a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener noreferrer">Laboratorio de aplicaciones educativas</a> | 
                        <a href="https://bilateria.org" target="_blank" rel="noopener noreferrer">Aplicación hecha por Juan José de Haro</a>
                    </p>
                    <p style="margin-bottom: 10px;">
                        <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" rel="noopener noreferrer">Licencia Creative Commons BY-SA</a>
                    </p>
                    <p style="margin-top: 20px; font-size: 0.8em; opacity: 0.7;">v.3.6</p>
                `;
            }

            // --- EVENT LISTENERS ---
            latexInput.addEventListener('input', updatePreview);
            toolbar.addEventListener('click', (event) => {
                const button = event.target.closest('.toolbar-btn');
                if (button && button.dataset.latex) insertAtCursor(button.dataset.latex);
            });
            tabsContainer.addEventListener('click', handleTabSwitch);
            
            copyButton.addEventListener('click', () => {
                const rawLatex = latexInput.value.trim();
                if (!rawLatex) return;

                let textToCopy;
                switch (delimiterSelector.value) {
                    case 'parentheses': textToCopy = `\\(${rawLatex}\\)`; break;
                    case 'brackets': textToCopy = `\\[\n${rawLatex}\n\\]`; break;
                    case 'double_dollar': textToCopy = `$$\n${rawLatex}\n$$`; break;
                    case 'single_dollar': textToCopy = `$${rawLatex}$`; break;
                    default: textToCopy = rawLatex;
                }
                navigator.clipboard.writeText(textToCopy);

                copyCodeFeedback.textContent = '¡Código copiado!';
                copyCodeFeedback.style.opacity = '1';
                setTimeout(() => { copyCodeFeedback.style.opacity = '0'; }, 2000);
            });

            clearButton.addEventListener('click', () => {
                latexInput.value = '';
                latexInput.focus();
                updatePreview();
            });

            viewImageButton.addEventListener('click', handleViewImage);
            imageModal.addEventListener('click', (e) => { if (e.target === imageModal) hideImageModal(); });
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettingsBtn.addEventListener('click', closeSettingsModal);
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeSettingsModal(); });
            urlInput.addEventListener('change', () => {if(urlInput.value) loadMenuFromUrl(urlInput.value)});
            fileInput.addEventListener('change', () => { if(fileInput.files.length > 0) loadMenuFromFile(fileInput.files[0]); });
            restoreDefaultBtn.addEventListener('click', restoreDefaultMenu);
            alertModalCloseBtn.addEventListener('click', hideAlert);
            alertModal.addEventListener('click', (e) => { if (e.target === alertModal) hideAlert(); });

            // --- INICIALIZACIÓN ---
            loadRecents();
            await initializeMenu();
            updatePreview();
            addFooter();
        }
    </script>
</body>
</html>
