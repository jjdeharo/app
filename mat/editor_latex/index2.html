<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor LaTeX online</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: {'[+]': ['cases', 'mathtools']}
            },
            svg: {
                fontCache: 'local'
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    initializeLatexEditor();
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --danger-dark: #a71d2a;
            --success-color: #28a745;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #495057;
            --white: #ffffff;
            --text-color: #212529;
            --border-radius: 12px;
            --box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; color: var(--white); }
        .header h1 { font-size: 2.5rem; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; margin: 0; }
        .tabs-section { position: relative; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 20px; overflow: hidden; }
        
        .search-wrapper { 
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px 10px 20px; 
            border-bottom: 1px solid var(--medium-gray); 
        }
        .search-input-container {
            position: relative;
            flex-grow: 1;
        }
        #search-input { 
            width: 100%;
            padding: 12px 40px 12px 12px; 
            border-radius: 8px; 
            border: 2px solid var(--medium-gray); 
            font-size: 1rem; 
            transition: all 0.3s ease; 
        }
        #search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        #clear-search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            font-size: 1.8rem;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            display: none;
        }
        #clear-search-btn:hover { color: var(--dark-gray); }
        #settings-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark-gray);
            transition: transform 0.3s, color 0.3s;
            padding: 0 5px;
            flex-shrink: 0;
        }
        #settings-btn:hover {
            color: var(--primary-color);
            transform: rotate(45deg);
        }
        .search-results-view .tabs-container { display: none; }
        .search-results-view .tab-content { display: grid !important; }
        .tabs-container { display: flex; flex-wrap: wrap; background: var(--light-gray); border-bottom: 3px solid var(--medium-gray); }
        .tab-btn { padding: 15px 20px; background: transparent; border: none; cursor: pointer; font-weight: 600; color: var(--dark-gray); transition: all 0.3s ease; position: relative; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: var(--medium-gray); color: var(--text-color); }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .toolbar-wrapper { padding: 20px; background: var(--white); }
        .tab-content { display: none; gap: 10px; }
        .tab-content.active { display: grid; }
        .toolbar-btn { background: var(--white); border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px 10px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; min-height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toolbar-btn:hover { border-color: var(--primary-color); background: #f8f9ff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.2); }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: var(--white); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); display: flex; flex-direction: column; }
        .panel h2 { margin: 0 0 15px 0; color: #333; font-size: 1.3rem; border-bottom: 2px solid var(--medium-gray); padding-bottom: 10px; }
        #latex-input { width: 100%; height: 200px; border: 2px solid var(--medium-gray); border-radius: 8px; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; transition: all 0.3s ease; flex-grow: 1; }
        #latex-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .preview-container { min-height: 200px; border: 2px dashed var(--medium-gray); border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: center; background: var(--light-gray); flex-grow: 1; }
        #preview { font-size: 24px; color: var(--text-color); overflow-x: auto; overflow-y: hidden; width: 100%; text-align: center; }
        .copy-options-container { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .copy-options-container label { font-size: 0.9rem; color: var(--dark-gray); font-weight: 500; }
        #delimiter-selector { font-family: inherit; padding: 5px 8px; border-radius: 8px; border: 2px solid var(--medium-gray); background-color: white; transition: border-color 0.2s ease-in-out; }
        #delimiter-selector:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        .panel-actions { margin-top: 15px; text-align: center; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-sm { padding: 5px 10px; font-size: 0.85rem; }
        .btn-primary { background: linear-gradient(45deg, var(--primary-color), var(--primary-dark)); color: white; }
        .btn-secondary { background: linear-gradient(45deg, var(--secondary-color), #495057); color: white; }
        .btn-danger { background: linear-gradient(45deg, var(--danger-color), var(--danger-dark)); color: white; }
        .btn-success { background: linear-gradient(45deg, var(--success-color), #1e7e34); color: white; }
        .btn:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }
        .copy-feedback { color: var(--primary-color); font-weight: 600; margin-top: 10px; height: 20px; opacity: 0; transition: opacity 0.5s ease; text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--white); padding: 30px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-width: 90vw; max-height: 90vh; text-align: left; transform: scale(0.9); transition: transform 0.3s; width: 600px; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2, .modal-content h3 { text-align: center; margin-top: 0; color: var(--text-color); }
        .modal-content h3 { margin-top: 20px; margin-bottom: 10px; border-top: 1px solid var(--medium-gray); padding-top: 20px; font-size: 1.1rem;}
        #modal-message { margin: 0 0 20px 0; font-size: 1.1rem; line-height: 1.5; text-align: center; }
        #modal-message img { display: block; margin: 0 auto; }
        #alert-modal-message p { margin: 0 0 10px 0; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 25px;}
        .modal-content .form-group { margin-bottom: 20px; }
        .modal-content .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .modal-content .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--medium-gray); font-size: 1rem; }
        #modal-feedback { font-size: 0.9em; height: 20px; text-align: center; }
        .modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px;}
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-list li { display: flex; align-items: center; padding: 8px; border-radius: 8px; transition: background-color 0.2s; }
        .menu-list li:nth-child(odd) { background-color: var(--light-gray); }
        .menu-list-item-name { font-weight: 500; margin-left: 10px; }
        .footer { text-align: center; padding: 30px 20px; color: white; opacity: 0.9; font-size: 0.9rem; }
        .footer a { color: #ffffff; font-weight: 600; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
        #clear-recents-btn-container { text-align: right; margin-top: 10px; }
        .matrix-builder {
            border: 2px solid var(--medium-gray); border-radius: var(--border-radius); padding: 10px; grid-column: 1 / -1; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px 15px; background-color: var(--light-gray);
        }
        .matrix-builder-group { display: flex; align-items: center; gap: 5px; }
        .matrix-builder-group label { font-size: 0.9em; font-weight: 500; color: var(--dark-gray); white-space: nowrap; }
        .matrix-builder-group input, .matrix-builder-group select { padding: 6px; border-radius: 8px; border: 2px solid var(--medium-gray); font-size: 0.9rem; width: 65px; }
        .matrix-builder-group select { width: auto; min-width: 140px; }
        .matrix-builder-delimiters { display: flex; align-items: center; gap: 8px; }
        .matrix-builder-delimiters .btn { padding: 6px 14px; font-size: 1.1rem; }

        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
        @media (max-width: 600px) {
            .header h1 { font-size: 2rem; } .tab-btn { padding: 12px 15px; font-size: 14px; } .container { padding: 10px; } .modal-content { padding: 20px; } .matrix-builder { justify-content: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Editor LaTeX online</h1>
            <p>Crea fórmulas matemáticas visualmente, cópialas o descárgalas como imagen.</p>
        </header>

        <div id="tabs-section" class="tabs-section">
            <div class="search-wrapper">
                <div class="search-input-container">
                    <input type="search" id="search-input" placeholder="Buscar por descripción o código (ej: fracción, \int)..." autocomplete="off">
                    <button id="clear-search-btn" title="Borrar búsqueda">&times;</button>
                </div>
                <button id="settings-btn" title="Personalizar menú">⚙️</button>
            </div>
            <div id="tabs-container" class="tabs-container"></div>
            <div class="toolbar-wrapper">
                <div id="toolbar"></div>
            </div>
        </div>

        <div class="main-content">
             <div class="panel">
                <h2>Código LaTeX</h2>
                <textarea id="latex-input" placeholder="Escribe aquí tu código... \frac{a}{b}" spellcheck="false"></textarea>
                <div class="copy-options-container">
                    <label for="delimiter-selector">Copiar con delimitadores:</label>
                    <select id="delimiter-selector" class="mathjax_ignore">
                        <option value="none" selected>Sin delimitadores</option>
                        <option value="parentheses">\(...\)</option>
                        <option value="brackets">\[...\]</option>
                        <option value="double_dollar">$$...$$</option>
                        <option value="single_dollar">$...$</option>
                    </select>
                </div>
                <div class="panel-actions">
                      <button id="copy-button" class="btn btn-primary">Copiar código LaTeX</button>
                      <button id="clear-button" class="btn btn-secondary">Borrar código</button>
                </div>
                <div id="copy-code-feedback" class="copy-feedback"></div>
            </div>
            <div class="panel">
                <h2>Previsualización</h2>
                <div class="preview-container">
                    <div id="preview"></div>
                </div>
                <div class="panel-actions">
                    <button id="view-image-button" class="btn btn-success">Visualizar imagen</button>
                </div>
                 <div id="copy-image-feedback" class="copy-feedback"></div>
            </div>
        </div>
    </div>
    
    <footer id="page-footer" class="footer"></footer>

    <div id="image-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-message"></div>
            <div id="modal-buttons" class="modal-buttons"></div>
        </div>
    </div>
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Gestionar menús</h2>
            <div class="modal-body">
                <h3>Menús disponibles</h3>
                <p style="font-size:0.9em; text-align:center; color: var(--secondary-color); margin-top: -10px;">Los menús se cargan desde <code>./docs/menu_index.json</code></p>
                <ul id="available-menus-list" class="menu-list"><li>Cargando...</li></ul>
                <div class="modal-buttons" style="justify-content: flex-end; margin-top: 10px;">
                    <button id="reload-menus-list-btn" class="btn btn-sm btn-secondary">Recargar lista</button>
                </div>

                <h3>Carga personalizada</h3>
                <div class="form-group">
                    <label for="url-input">Cargar menú desde URL externa</label>
                    <input type="url" id="url-input" placeholder="https://ejemplo.com/formulas.json">
                </div>
                <div class="form-group">
                    <label for="file-input">Cargar menú desde archivo local</label>
                    <input type="file" id="file-input" accept=".json,application/json">
                </div>
                <h3>Acciones</h3>
                <div id="modal-feedback" style="margin-bottom: 15px;"></div>
                <div class="modal-buttons" style="flex-wrap: wrap; justify-content: center;">
                    <a href="./editor_menu.html" target="_blank" class="btn btn-primary">Crear o editar menús</a>
                    <button id="clear-cache-btn" class="btn btn-secondary">Limpiar caché y recargar</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="close-settings-btn" class="btn btn-primary">Cerrar</button>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="alert-modal-title" style="text-align: center;"></h2>
            <div id="alert-modal-message" style="font-size: 1rem; line-height: 1.5;"></div>
            <div class="modal-buttons">
                <button id="alert-modal-close-btn" class="btn btn-primary">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        async function initializeLatexEditor() {
            // --- REFERENCIAS AL DOM ---
            const latexInput = document.getElementById('latex-input');
            const preview = document.getElementById('preview');
            const copyButton = document.getElementById('copy-button');
            const clearButton = document.getElementById('clear-button');
            const viewImageButton = document.getElementById('view-image-button');
            const delimiterSelector = document.getElementById('delimiter-selector');
            const copyCodeFeedback = document.getElementById('copy-code-feedback');
            const tabsContainer = document.getElementById('tabs-container');
            const toolbar = document.getElementById('toolbar');
            const searchInput = document.getElementById('search-input');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsBtn = document.getElementById('close-settings-btn');
            const urlInput = document.getElementById('url-input');
            const fileInput = document.getElementById('file-input');
            const modalFeedback = document.getElementById('modal-feedback');
            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalCloseBtn = document.getElementById('alert-modal-close-btn');
            const availableMenusList = document.getElementById('available-menus-list');
            const reloadMenusListBtn = document.getElementById('reload-menus-list-btn');
            const clearCacheBtn = document.getElementById('clear-cache-btn');
            
            // --- CONFIGURACIÓN ---
            const MENU_INDEX_URL = './docs/menu_index.json';
            const DEFAULT_MENU_LOCAL_URL = './formulas.json';
            const MAX_RECENTS = 12;

            // --- ESTADO DE LA APLICACIÓN ---
            let loadedMenus = new Map();
            let menuCache = new Map();
            let menuListCache = null;
            let recentSymbols = [];
            
            // --- GESTIÓN DE DATOS Y ESTADO (Recientes y Menús) ---
            const loadRecents = () => {
                recentSymbols = JSON.parse(localStorage.getItem('latexRecents')) || [];
            };
            const saveRecents = () => {
                localStorage.setItem('latexRecents', JSON.stringify(recentSymbols));
            };
            const clearRecents = () => {
                recentSymbols = [];
                localStorage.removeItem('latexRecents');
                rebuildToolbarAndUI();
            };
            const createRecentsTab = () => {
                if (document.querySelector('[data-tab="recientes"]')) return;
                const recentsTabButton = document.createElement('button');
                recentsTabButton.className = 'tab-btn';
                recentsTabButton.dataset.tab = 'recientes';
                recentsTabButton.textContent = 'Recientes';
                tabsContainer.prepend(recentsTabButton);
                const recentsContentDiv = document.createElement('div');
                recentsContentDiv.id = 'tab-recientes';
                recentsContentDiv.className = 'tab-content';
                toolbar.prepend(recentsContentDiv);
            };
            const trackSymbolUsage = (latexCode) => {
                const wasEmpty = recentSymbols.length === 0;
                recentSymbols = recentSymbols.filter(item => item !== latexCode);
                recentSymbols.unshift(latexCode);
                if (recentSymbols.length > MAX_RECENTS) recentSymbols = recentSymbols.slice(0, MAX_RECENTS);
                saveRecents();
                if (wasEmpty) {
                    rebuildToolbarAndUI();
                } else {
                    const recentsContent = document.getElementById('tab-recientes');
                    if (recentsContent && recentsContent.classList.contains('active')) {
                        renderTabContent('recientes', getAllCategories());
                    }
                }
            };
            const saveAddedMenusToStorage = () => {
                const added = Array.from(loadedMenus.values())
                    .filter(m => m.source === 'url' || m.source === 'localfile_user') // Solo guardar los añadidos explícitamente por el usuario
                    .map(m => ({ id: m.id, url: m.url, source: m.source, name: m.name }));
                localStorage.setItem('latexAddedMenus', JSON.stringify(added));
            };
            const loadAddedMenusFromStorage = () => {
                return JSON.parse(localStorage.getItem('latexAddedMenus')) || [];
            };

            // --- LÓGICA DE CARGA Y GESTIÓN DE MENÚS ---
            const fetchMenuData = async (url) => {
                if (menuCache.has(url)) {
                    return menuCache.get(url);
                }
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status} al intentar cargar ${url}`);
                    }
                    const data = await response.json();
                    menuCache.set(url, data);
                    return data;
                } catch (error) {
                    console.error(`Error al obtener el menú desde ${url}:`, error);
                    showModalFeedback(`Error al cargar ${url}`, true);
                    return null;
                }
            };

            const addMenu = async (menuInfo) => {
                if (loadedMenus.has(menuInfo.id)) return;
                
                let data;
                if (menuInfo.source === 'localfile_user' && menuInfo.data) {
                    data = menuInfo.data; // Usar datos ya leídos del archivo
                } else {
                    data = await fetchMenuData(menuInfo.url);
                }
                
                if (data) {
                    // Si el menuInfo no tiene 'data', se lo añadimos
                    const newMenuInfo = { ...menuInfo, data };
                    loadedMenus.set(menuInfo.id, newMenuInfo);
                    rebuildToolbarAndUI();
                    if(menuInfo.source === 'url' || menuInfo.source === 'localfile_user') {
                        saveAddedMenusToStorage();
                    }
                }
            };
            const removeMenu = (menuId) => {
                const menu = loadedMenus.get(menuId);
                if (menu && menu.source !== 'default') {
                    loadedMenus.delete(menuId);
                    rebuildToolbarAndUI();
                    saveAddedMenusToStorage();
                }
            };
            const getAllCategories = () => {
                const allCategories = new Map();
                const menuOrder = ['default', 'docs', 'url', 'localfile_user'];
                const sortedMenus = Array.from(loadedMenus.values()).sort((a,b) => menuOrder.indexOf(a.source) - menuOrder.indexOf(b.source));

                for (const menu of sortedMenus) {
                    if (!menu.data || !menu.data.categorias) continue;
                    for (const categoria of menu.data.categorias) {
                        if (!allCategories.has(categoria.id)) {
                             allCategories.set(categoria.id, { ...categoria, elementos: [...categoria.elementos] });
                        } else {
                            const existingCategory = allCategories.get(categoria.id);
                            existingCategory.elementos.push(...categoria.elementos);
                        }
                    }
                }
                return allCategories;
            };
            const rebuildToolbarAndUI = () => {
                tabsContainer.innerHTML = '';
                toolbar.innerHTML = '';
                const allCategories = getAllCategories();
                let isFirstTab = true;
                if (recentSymbols.length > 0) {
                    createRecentsTab();
                    tabsContainer.querySelector('[data-tab="recientes"]').classList.add('active');
                    toolbar.querySelector('#tab-recientes').classList.add('active');
                    isFirstTab = false;
                }
                allCategories.forEach((categoria) => {
                    const tabButton = document.createElement('button');
                    tabButton.className = 'tab-btn';
                    tabButton.dataset.tab = categoria.id;
                    tabButton.textContent = categoria.nombre;
                    tabsContainer.appendChild(tabButton);
                    const contentDiv = document.createElement('div');
                    contentDiv.id = `tab-${categoria.id}`;
                    contentDiv.className = 'tab-content';
                    toolbar.appendChild(contentDiv);
                    if (isFirstTab) {
                        tabButton.classList.add('active');
                        contentDiv.classList.add('active');
                        isFirstTab = false;
                    }
                });
                const activeTab = tabsContainer.querySelector('.tab-btn.active');
                if (activeTab) {
                    renderTabContent(activeTab.dataset.tab, allCategories);
                }
                loadAndDisplayAvailableMenus();
            };
            const initializeApp = async () => {
                loadRecents();
                loadedMenus.clear();
                menuCache.clear();
                menuListCache = null;

                // Cargar el menú base local. Es fundamental.
                try {
                    const baseMenuData = await fetchMenuData(DEFAULT_MENU_LOCAL_URL);
                    if (baseMenuData) {
                        loadedMenus.set('formulas.json', { id: 'formulas.json', url: DEFAULT_MENU_LOCAL_URL, source: 'default', name: 'Base', data: baseMenuData });
                    } else {
                       throw new Error("El archivo base 'formulas.json' no se pudo cargar o está vacío.");
                    }
                } catch(e) {
                    console.error(e);
                    showAlert("Error crítico", "No se pudo cargar el archivo base <code>formulas.json</code>. La aplicación no puede funcionar sin él. Asegúrate de que el archivo existe y es accesible.");
                    return;
                }
                
                // Cargar menús añadidos explícitamente por el usuario (URL/archivo) desde localStorage
                const previouslyAdded = loadAddedMenusFromStorage();
                for (const menuInfo of previouslyAdded) {
                    await addMenu(menuInfo);
                }
                rebuildToolbarAndUI();
                updatePreview();
                addFooter();
            };

            // --- LÓGICA DE LA INTERFAZ DE USUARIO (UI) ---
            const renderAvailableMenus = (menuItemsMap) => {
                availableMenusList.innerHTML = '';
                if(menuItemsMap.size === 0 && !Array.from(loadedMenus.values()).some(m => m.source === 'default')) {
                     availableMenusList.innerHTML = '<li>No se encontraron menús.</li>';
                     return;
                }

                menuItemsMap.forEach(menu => {
                    const li = document.createElement('li');
                    
                    if (menu.source === 'error') {
                        li.innerHTML = `<span style="color: var(--danger-color); font-style: italic; width: 100%; text-align: center;">${menu.name}</span>`;
                        availableMenusList.appendChild(li);
                        return;
                    }

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `menu-checkbox-${menu.id}`;
                    checkbox.checked = loadedMenus.has(menu.id);
                    checkbox.dataset.id = menu.id;
                    checkbox.dataset.url = menu.url;
                    checkbox.dataset.name = menu.name;
                    checkbox.dataset.source = menu.source;

                    const label = document.createElement('label');
                    label.htmlFor = `menu-checkbox-${menu.id}`;
                    label.className = 'menu-list-item-name';
                    label.textContent = menu.name || menu.id;
                    
                    if(menu.source === 'default') {
                        checkbox.disabled = true;
                        label.innerHTML += ` <em style="font-weight:normal; font-size:0.9em; color: var(--secondary-color)">(Base)</em>`;
                    }

                    li.appendChild(checkbox);
                    li.appendChild(label);
                    availableMenusList.appendChild(li);
                });
            };
            const loadAndDisplayAvailableMenus = async (forceRefetch = false) => {
                if (!forceRefetch && menuListCache) {
                    renderAvailableMenus(menuListCache);
                    return;
                }
                if(forceRefetch) {
                    menuListCache = null;
                    menuCache.clear();
                }

                availableMenusList.innerHTML = '<li>Cargando...</li>';
                const menuItems = new Map();

                // Siempre mostrar el menú base si está cargado
                const baseMenu = loadedMenus.get('formulas.json');
                if(baseMenu) menuItems.set(baseMenu.id, { ...baseMenu });

                // Cargar la lista de menús desde el archivo de índice local
                try {
                    const menuIndex = await fetchMenuData(MENU_INDEX_URL);
                    if (menuIndex && Array.isArray(menuIndex)) {
                        menuIndex.forEach(menuInfo => {
                            if(menuInfo.file && menuInfo.name) {
                                menuItems.set(menuInfo.file, {
                                    id: menuInfo.file,
                                    name: menuInfo.name,
                                    url: `./docs/${menuInfo.file}`,
                                    source: 'docs'
                                });
                            }
                        });
                    } else {
                         throw new Error('Índice de menús no válido.');
                    }
                } catch(e) {
                    console.warn(e.message);
                    const errorItem = { id: 'error-menu-index', name: `Aviso: No se pudo cargar <code>./docs/menu_index.json</code>.`, source: 'error' };
                    menuItems.set(errorItem.id, errorItem);
                }
                
                // Añadir los menús cargados por el usuario que no estén ya en la lista
                for (const menu of loadedMenus.values()){
                     if (!menuItems.has(menu.id)) {
                        menuItems.set(menu.id, {...menu});
                    }
                }
                
                menuListCache = menuItems;
                renderAvailableMenus(menuItems);
            };

            availableMenusList.addEventListener('change', (e) => {
                const checkbox = e.target;
                if(checkbox.type !== 'checkbox') return;
                
                const menuInfo = {
                    id: checkbox.dataset.id,
                    url: checkbox.dataset.url,
                    name: checkbox.dataset.name,
                    source: checkbox.dataset.source
                };

                if (checkbox.checked) {
                    addMenu(menuInfo);
                } else {
                    removeMenu(menuInfo.id);
                }
            });

            function showAlert(title, htmlMessage) {
                alertModalTitle.textContent = title;
                alertModalMessage.innerHTML = htmlMessage;
                alertModal.classList.add('active');
            }
            function hideAlert() { alertModal.classList.remove('active'); }
            function showImageModal(message, buttons) {
                const modalMessage = document.getElementById('modal-message');
                const modalButtons = document.getElementById('modal-buttons');
                modalMessage.innerHTML = message;
                modalButtons.innerHTML = '';
                buttons.forEach(btnInfo => {
                    const button = document.createElement('button');
                    button.textContent = btnInfo.text;
                    button.className = `btn ${btnInfo.class}`;
                    button.onclick = () => {
                        if(btnInfo.action) btnInfo.action();
                        document.getElementById('image-modal').classList.remove('active');
                    };
                    modalButtons.appendChild(button);
                });
                document.getElementById('image-modal').classList.add('active');
            }
            function openSettingsModal() { 
                loadAndDisplayAvailableMenus();
                settingsModal.classList.add('active'); 
            }
            function closeSettingsModal() { settingsModal.classList.remove('active'); }
            function showModalFeedback(message, isError = false) {
                modalFeedback.textContent = message;
                modalFeedback.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
                setTimeout(() => modalFeedback.textContent = '', 3000);
            }
             function updatePreview() {
                preview.innerHTML = latexInput.value.trim() === "" ? "" : `$$${latexInput.value.trim()}$$`;
                MathJax.typesetPromise([preview]).catch(err => {
                    preview.innerHTML = `<span style="color:red;">Error de sintaxis</span>`;
                });
            }
            function insertAtCursor(textToInsert) {
                const startPos = latexInput.selectionStart;
                const endPos = latexInput.selectionEnd;
                latexInput.value = latexInput.value.substring(0, startPos) + textToInsert + latexInput.value.substring(endPos);
                let cursorPos = textToInsert.indexOf('{}');
                latexInput.selectionStart = latexInput.selectionEnd = startPos + (cursorPos !== -1 ? cursorPos + 1 : textToInsert.length);
                latexInput.focus();
                updatePreview();
                if (textToInsert.includes('\\begin{')) return;
                trackSymbolUsage(textToInsert);
            }
            function generateImage(callback) {
                const svgElement = preview.querySelector('svg');
                if (!svgElement) {
                    showImageModal('<p>No hay fórmula para capturar.</p>', [{text: 'OK', class: 'btn-primary'}]);
                    return;
                }
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgElement);
                const img = new Image();
                const svgBlob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
                const url = URL.createObjectURL(svgBlob);
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const padding = 20;
                    canvas.width = svgElement.width.baseVal.value + padding * 2;
                    canvas.height = svgElement.height.baseVal.value + padding * 2;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, padding, padding, svgElement.width.baseVal.value, svgElement.height.baseVal.value);
                    URL.revokeObjectURL(url);
                    callback(canvas);
                };
                img.src = url;
            }
            function handleViewImage() {
                generateImage(canvas => {
                    const imgElement = document.createElement('img');
                    imgElement.src = canvas.toDataURL('image/png');
                    imgElement.style.maxWidth = '100%';
                    imgElement.style.maxHeight = '80vh';
                    const instruction = document.createElement('p');
                    instruction.textContent = 'Clic derecho sobre la imagen para guardarla o copiarla.';
                    const messageContainer = document.createElement('div');
                    messageContainer.appendChild(imgElement);
                    messageContainer.appendChild(instruction);
                    showImageModal(messageContainer.innerHTML, [{text: 'Cerrar', class: 'btn-secondary'}]);
                });
            }
            function createMatrixBuilderUI(elemento) {
                const container = document.createElement('div');
                container.className = 'matrix-builder';
                container.dataset.title = elemento.title || 'Matriz personalizada';
                container.innerHTML = `
                    <div class="matrix-builder-group">
                        <label for="mb-rows">Filas:</label>
                        <input type="number" id="mb-rows" value="2" min="1" max="20">
                    </div>
                    <div class="matrix-builder-group">
                        <label for="mb-cols">Columnas:</label>
                        <input type="number" id="mb-cols" value="2" min="1" max="20">
                    </div>
                    <div class="matrix-builder-group">
                        <label for="mb-fill">Rellenar:</label>
                        <select id="mb-fill">
                            <option value="subscripts">Subíndices (a, b...)</option>
                            <option value="zeros">Ceros (0)</option>
                            <option value="ones">Unos (1)</option>
                            <option value="vars">Variables (a, b, c...)</option>
                            <option value="numbers">Números (1, 2, 3...)</option>
                            <option value="empty">Vacío ({})</option>
                        </select>
                    </div>
                    <div class="matrix-builder-delimiters">
                        <button class="btn" data-delimiter="pmatrix">()</button>
                        <button class="btn" data-delimiter="bmatrix">[]</button>
                        <button class="btn" data-delimiter="vmatrix">||</button>
                        <button class="btn" data-delimiter="Vmatrix">|||</button>
                    </div>
                `;
                container.querySelector('.matrix-builder-delimiters').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const rows = parseInt(container.querySelector('#mb-rows').value, 10);
                    const cols = parseInt(container.querySelector('#mb-cols').value, 10);
                    const fillType = container.querySelector('#mb-fill').value;
                    const delimiter = button.dataset.delimiter;
                    const matrixCode = generateMatrixCode(rows, cols, fillType, delimiter);
                    insertAtCursor(matrixCode);
                });
                return container;
            }
            function generateMatrixCode(rows, cols, fillType, delimiter) {
                if (isNaN(rows) || isNaN(cols) || rows < 1 || cols < 1) return '';
                let content = '';
                const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                let counter = 0;
                for (let i = 1; i <= rows; i++) {
                    for (let j = 1; j <= cols; j++) {
                        let cell;
                        switch(fillType) {
                            case 'subscripts': cell = `a_{${i}${j}}`; break;
                            case 'zeros': cell = '0'; break;
                            case 'ones': cell = '1'; break;
                            case 'vars': cell = alphabet[counter % alphabet.length]; counter++; break;
                            case 'numbers': cell = (counter + 1).toString(); counter++; break;
                            case 'empty': cell = '{}'; break;
                            default: cell = '';
                        }
                        content += cell + (j < cols ? ' & ' : '');
                    }
                    if (i < rows) content += ' \\\\\n  ';
                }
                return `\\begin{${delimiter}}\n  ${content}\n\\end{${delimiter}}`;
            }
            function normalizeString(str) {
                if (typeof str !== 'string') return '';
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }
            function renderTabContent(tabId, allCategories) {
                const contentDiv = document.getElementById(`tab-${tabId}`);
                if (!contentDiv) return;
                contentDiv.innerHTML = '';

                let elementsToRender = [];
                let gridColumns = "repeat(auto-fill, minmax(80px, 1fr))";

                if (tabId === 'recientes') {
                    if (recentSymbols.length === 0) {
                         contentDiv.innerHTML = `<p style="color: var(--dark-gray); grid-column: 1 / -1; text-align:center;">Aún no hay símbolos recientes.</p>
                         <div id="clear-recents-btn-container" style="grid-column: 1 / -1;"><button id="clear-recents-btn" class="btn btn-sm btn-danger">Borrar recientes</button></div>`;
                         document.getElementById('clear-recents-btn').onclick = clearRecents;
                         return;
                    }
                    recentSymbols.forEach(latexCode => {
                        let symbolFound = false;
                        for (const menu of loadedMenus.values()) {
                            if (symbolFound) break;
                            if (!menu.data || !menu.data.categorias) continue;
                            for (const categoria of menu.data.categorias) {
                                if (symbolFound) break;
                                const found = categoria.elementos.find(el => el && el.latex === latexCode);
                                if (found) {
                                    elementsToRender.push(found);
                                    symbolFound = true;
                                }
                            }
                        }
                    });
                } else {
                    const categoria = allCategories.get(tabId);
                    if (categoria) {
                        elementsToRender = categoria.elementos;
                        gridColumns = categoria.grid_template_columns || gridColumns;
                    }
                }
                
                contentDiv.style.gridTemplateColumns = gridColumns;

                elementsToRender.forEach(elemento => {
                    if (!elemento) return;
                    if (elemento.type === 'custom_matrix') {
                        const matrixBuilder = createMatrixBuilderUI(elemento);
                        contentDiv.appendChild(matrixBuilder);
                    } else if (elemento.latex) {
                        const button = document.createElement('button');
                        button.className = 'toolbar-btn';
                        button.dataset.latex = elemento.latex;
                        button.title = elemento.title;
                        button.innerHTML = `\\(${elemento.display || elemento.latex}\\)`;
                        contentDiv.appendChild(button);
                    }
                });
                
                if (tabId === 'recientes' && recentSymbols.length > 0) {
                     const clearBtnContainer = document.createElement('div');
                     clearBtnContainer.id = 'clear-recents-btn-container';
                     clearBtnContainer.style.gridColumn = '1 / -1';
                     const clearBtn = document.createElement('button');
                     clearBtn.id = 'clear-recents-btn';
                     clearBtn.className = 'btn btn-sm btn-danger';
                     clearBtn.textContent = 'Borrar recientes';
                     clearBtn.onclick = clearRecents;
                     clearBtnContainer.appendChild(clearBtn);
                     contentDiv.appendChild(clearBtnContainer);
                }

                MathJax.typesetPromise(contentDiv.querySelectorAll('.toolbar-btn'));
            }
            function handleTabSwitch(event) {
                const button = event.target.closest('.tab-btn');
                if (!button) return;
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                toolbar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(`tab-${tabId}`).classList.add('active');
                renderTabContent(tabId, getAllCategories());
            }
            let allTabsRenderedForSearch = false;
            searchInput.addEventListener('input', (e) => {
                const hasText = e.target.value.length > 0;
                clearSearchBtn.style.display = hasText ? 'block' : 'none';
                const query = normalizeString(e.target.value.trim());
                tabsContainer.parentElement.classList.toggle('search-results-view', query.length > 0);
                
                if (query.length > 0) {
                    if (!allTabsRenderedForSearch) {
                        const allCategories = getAllCategories();
                        allCategories.forEach(cat => renderTabContent(cat.id, allCategories));
                        allTabsRenderedForSearch = true;
                    }
                    toolbar.querySelectorAll('.toolbar-btn').forEach(btn => {
                        const title = normalizeString(btn.title);
                        const latex = normalizeString(btn.dataset.latex);
                        const isVisible = title.includes(query) || latex.includes(query);
                        btn.style.display = isVisible ? 'flex' : 'none';
                    });
                     toolbar.querySelectorAll('.matrix-builder').forEach(builder => {
                        const title = normalizeString(builder.dataset.title);
                        builder.style.display = title.includes(query) ? 'flex' : 'none';
                    });
                } else {
                     allTabsRenderedForSearch = false;
                    toolbar.querySelectorAll('.toolbar-btn').forEach(btn => { btn.style.display = 'flex'; });
                    toolbar.querySelectorAll('.matrix-builder').forEach(builder => { builder.style.display = 'flex'; });
                    rebuildToolbarAndUI();
                }
            });
            function addFooter() {
                const footer = document.getElementById('page-footer');
                footer.innerHTML = `
                    <p style="margin-bottom: 10px;">
                        <a href="https://labia.tiddlyhost.com" target="_blank" rel="noopener noreferrer">Laboratorio de aplicaciones educativas</a> | 
                        <a href="https://bilateria.org" target="_blank" rel="noopener noreferrer">Aplicación hecha por Juan José de Haro</a>
                    </p>
                    <p style="margin-bottom: 10px;">
                        <a href="https://github.com/jjdeharo/app/tree/main/mat/editor_latex" target="_blank" rel="noopener noreferrer">Código del proyecto en GitHub</a>
                    </p>
                    <p style="margin-bottom: 10px;">
                        <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.es" target="_blank" rel="noopener noreferrer">Licencia Creative Commons BY-SA</a>
                    </p>
                    <p style="margin-top: 20px; font-size: 0.8em; opacity: 0.7;">v5.0</p>
                `;
            }

            // --- EVENT LISTENERS ---
            latexInput.addEventListener('input', updatePreview);
            toolbar.addEventListener('click', (event) => {
                const button = event.target.closest('.toolbar-btn');
                if (button && button.dataset.latex) insertAtCursor(button.dataset.latex);
            });
            tabsContainer.addEventListener('click', handleTabSwitch);
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                searchInput.focus();
            });
            copyButton.addEventListener('click', () => {
                const rawLatex = latexInput.value.trim();
                if (!rawLatex) return;
                let textToCopy;
                switch (delimiterSelector.value) {
                    case 'parentheses': textToCopy = `\\(${rawLatex}\\)`; break;
                    case 'brackets': textToCopy = `\\[\n${rawLatex}\n\\]`; break;
                    case 'double_dollar': textToCopy = `$$\n${rawLatex}\n$$`; break;
                    case 'single_dollar': textToCopy = `$${rawLatex}$`; break;
                    default: textToCopy = rawLatex;
                }
                navigator.clipboard.writeText(textToCopy);
                copyCodeFeedback.textContent = '¡Código copiado!';
                copyCodeFeedback.style.opacity = '1';
                setTimeout(() => { copyCodeFeedback.style.opacity = '0'; }, 2000);
            });
            clearButton.addEventListener('click', () => {
                latexInput.value = '';
                latexInput.focus();
                updatePreview();
            });
            viewImageButton.addEventListener('click', handleViewImage);
            document.getElementById('image-modal').addEventListener('click', (e) => { if (e.target.id === 'image-modal') document.getElementById('image-modal').classList.remove('active'); });
            settingsBtn.addEventListener('click', openSettingsModal);
            closeSettingsBtn.addEventListener('click', closeSettingsModal);
            settingsModal.addEventListener('click', (e) => { if(e.target === settingsModal) closeSettingsModal(); });
            urlInput.addEventListener('change', async () => {
                if(urlInput.value) {
                    const menuInfo = {id: urlInput.value, url: urlInput.value, source: 'url', name: urlInput.value};
                    await addMenu(menuInfo);
                    loadAndDisplayAvailableMenus();
                    urlInput.value = '';
                }
            });
            fileInput.addEventListener('change', () => { 
                if(fileInput.files.length > 0) {
                     const file = fileInput.files[0];
                     const reader = new FileReader();
                     reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            const menuInfo = {id: file.name, url: file.name, source: 'localfile_user', name: file.name, data: data };
                            addMenu(menuInfo);
                        } catch (error) {
                             showModalFeedback('El archivo no es un JSON válido.', true);
                        }
                    };
                    reader.readAsText(file);
                    fileInput.value = '';
                }
            });
            reloadMenusListBtn.addEventListener('click', () => loadAndDisplayAvailableMenus(true));
            clearCacheBtn.addEventListener('click', () => {
                localStorage.removeItem('latexAddedMenus');
                localStorage.removeItem('latexRecents');
                showModalFeedback('Caché y menús añadidos limpiados.');
                initializeApp();
            });
            alertModalCloseBtn.addEventListener('click', hideAlert);
            alertModal.addEventListener('click', (e) => { if (e.target === alertModal) hideAlert(); });

            initializeApp();
        }
    </script>
</body>
</html>
